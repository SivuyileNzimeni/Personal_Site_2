{
  "hash": "693fad4f911cde7a335a9ed4cef0371d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"2023 TidyTuesday Week 1\"\nimage: \"download.jpg\"\nimage-alt: \"Choropleth map of election results in South Africa in 2021\"\nlang: \"en-GB\"\ndate: \"January 06,2023\"\nauthor: \"Sivuyile Nzimeni\"\ndescription: \"Visualising Spatial Data in R using data from the IEC and Municipal Dermacation Board in South Africa.\"\ncategories: [spatial data,data cleaning,visualisation]\nfig-dpi: 300\nfig-align: 'center'\nfig-cap-location: 'top'\ncode-copy: true\ncode-line-numbers: true\npage-layout: 'article'\ncap-location: 'margin'\nnumber-sections: true\ntoc: true\ntoc-title: 'CONTENTS'\nexecute: \n  echo: true\n  warning: false\nbibliography: references.bib\n---\n\n\n# INTRODUCTION\n\nIt has a been more than a year since, I published a [#TidyTuesday](https://github.com/rfordatascience/tidytuesday) submission, a weekly, data visualisation activity featuring a varied range of datasets. For the first week of 2023, the activity encourages participants to Bring their own data. Fortunately, I have been seating on a dataset from @independentelectoralcommissionofsouthafrica2023 containing the 2021 Local Government Election Results. The dataset is detailed, including results down to voting station level. The IEC also provides a data dictionary along with detailed methodology on how the results can be interpreted. We aren't here to reproduce that process (that is for another day). We simply want to enhance the visualisation of the results.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlapply(c(\"tidyverse\",\"janitor\",\"arrow\",\n         \"sf\",\"ggthemes\",\"showtext\",\n         \"leaflet\"),\n       require,character.only = TRUE) |> \n  suppressWarnings() |> \n  suppressMessages()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[[1]]\n[1] TRUE\n\n[[2]]\n[1] TRUE\n\n[[3]]\n[1] TRUE\n\n[[4]]\n[1] TRUE\n\n[[5]]\n[1] TRUE\n\n[[6]]\n[1] TRUE\n\n[[7]]\n[1] TRUE\n```\n\n\n:::\n\n```{.r .cell-code}\nfont_add_google(\"IBM Plex Sans\")\nshowtext_auto()\n```\n:::\n\n\n# IMPORTANT DATA ASPECTS\n\nIn South Africa, the @municipaldemarcationboard2023 , is the body responsible for the demarcation of South Africa into multiple levels such as District Municipalities, Metropolitan Municipalities, Local Municipalities and Voting Districts. In Local Government Elections, these demarcations in turn, determine seat allocation and across all types of municipalities.\n\nThere important nuances in respect to the Local Government Elections voting ballots; such as direct (Ward-level vote) and indirect votes(proportional representation). For purposes of this analysis, we will rely on illustrating voting outcomes at ward level. In effect, we have two datasets to work with, 2020 Municipal Demarcation Board ShapeFile and 2021 Local Government Election Results (Comma-Separated File).\n\nWrangling spatial data is made easy by the `sf` package ( @pebesma2022 ). The voting results can be wrangled and joined to the `sf` object through the `dplyr` package ( @wickham2022 ). Since this is R, there are a plethora of data visualisation packages to utilise as well. Here, we chiefly rely on two, `ggplot2` and `leaflet`. The first can be used to create static maps while the latter offers a great set of tools for interactive visualisations. Below, we illustrate the process of importing that spatial data into R along with the csv of election results.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nSA_Wards <- st_read(\"./2020_Spatial_Data/SA_Wards2020.shp\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `SA_Wards2020' from data source \n  `C:\\Users\\Sivuyile\\Desktop\\RStudio\\2024\\2024_Personal_Site\\posts\\2023 TidyTuesday Week 1\\2020_Spatial_Data\\SA_Wards2020.shp' \n  using driver `ESRI Shapefile'\nSimple feature collection with 4468 features and 9 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 16.45189 ymin: -34.83417 xmax: 32.94498 ymax: -22.12503\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n\n```{.r .cell-code}\nElection_Results <- read_parquet(file = \"./Final_Dbs/2016 - 2021_Local_Gov_Election_Results_2022-04-27.parquet\") |>\n  filter(election_year == 2021)\n\nglimpse(Election_Results)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 1,084,734\nColumns: 13\n$ source_file         <chr> \"./2021/EC.csv\", \"./2021/EC.csv\", \"./2021/EC.csv\",…\n$ province            <chr> \"Eastern Cape\", \"Eastern Cape\", \"Eastern Cape\", \"E…\n$ municipality        <chr> \"BUF - Buffalo City\", \"BUF - Buffalo City\", \"BUF -…\n$ ward                <chr> \"Ward 29200001\", \"Ward 29200001\", \"Ward 29200001\",…\n$ voting_district     <dbl> 10590151, 10590151, 10590151, 10590151, 10590151, …\n$ voting_station_name <chr> \"PEFFERVILLE CLINIC\", \"PEFFERVILLE CLINIC\", \"PEFFE…\n$ registered_voters   <dbl> 2724, 2724, 2724, 2724, 2724, 2724, 2724, 2724, 27…\n$ ballot_type         <chr> \"PR\", \"PR\", \"PR\", \"PR\", \"PR\", \"PR\", \"PR\", \"PR\", \"P…\n$ spoilt_votes        <dbl> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,…\n$ party_name          <chr> \"ABANTU BATHO CONGRESS\", \"AFRICA RESTORATION ALLIA…\n$ total_valid_votes   <dbl> 3, 6, 3, 7, 0, 286, 1, 1, 0, 0, 1, 0, 3, 615, 24, …\n$ date_generated      <chr> \"11/23/2021 4:17:50 PM\", \"11/23/2021 4:17:50 PM\", …\n$ election_year       <dbl> 2021, 2021, 2021, 2021, 2021, 2021, 2021, 2021, 20…\n```\n\n\n:::\n:::\n\n\nAs mentioned above, we are only interested in Ward Ballot results, as a result, we filter out all indirect ballot types. Thereafter, we group the data by Province, Municipality and Ward and derive a sum of all valid votes. In other words, we exclude spoilt votes and do not consider voter turn out extra. We store the result in a data-frame called \\`Total \\_Votes\\`. As the name implies, the data-frame contains a sum of total valid votes per ward. Below, we add an additional variable, party-name, which helps us tally all the votes cast for a particular party or independent cast per ward. Finally, we filter for the maximum votes accumulated by the party/independent per ward.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nTotal_Votes <- Election_Results |>\n  filter(ballot_type == \"Ward\") |> \n  group_by(across(.cols=c(province,municipality,ward))) |> \n  summarise(total_votes = sum(total_valid_votes),\n            .groups = \"drop\")\n\nWard_Results <-  Total_Votes |> \n  left_join(Election_Results |> \n              filter(ballot_type == \"Ward\") |>   \n  group_by(across(.cols=c(ward,party_name))) |> \n  summarise(party_votes= sum(total_valid_votes)) |>\n    filter(party_votes == max(party_votes)) |> \n    ungroup()) |> \n  mutate(support = 100/total_votes*party_votes)\n\nglimpse(Ward_Results)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 4,468\nColumns: 7\n$ province     <chr> \"Eastern Cape\", \"Eastern Cape\", \"Eastern Cape\", \"Eastern …\n$ municipality <chr> \"BUF - Buffalo City\", \"BUF - Buffalo City\", \"BUF - Buffal…\n$ ward         <chr> \"Ward 29200001\", \"Ward 29200002\", \"Ward 29200003\", \"Ward …\n$ total_votes  <dbl> 3803, 3299, 3326, 4524, 3506, 3421, 3446, 3917, 3359, 305…\n$ party_name   <chr> \"AFRICAN NATIONAL CONGRESS\", \"AFRICAN NATIONAL CONGRESS\",…\n$ party_votes  <dbl> 1748, 2883, 1630, 2561, 1912, 1420, 2174, 2397, 1513, 150…\n$ support      <dbl> 45.96371, 87.39012, 49.00782, 56.60920, 54.53508, 41.5083…\n```\n\n\n:::\n:::\n\n\nTo finalise the ward results, the two data-frames are joined. Ultimately, we have a data-frame with the winner of the ward. To visualise the data, we join the spatial data to the ward results data-frame.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nWard_Results <- left_join(SA_Wards,Ward_Results |>\n  mutate(ward = str_remove(ward,\"Ward\\\\s{1,}\")) |> \n  rename(WardID = ward) |> \n  select(-province))\n```\n:::\n\n\nBefore completing our first visualisation, there are some mopping up required. These are mainly for aesthetic in nature, such as importing hex codes for each political party which largely resembles the respective party's corporate colour and grouping colours for smaller parties ($parties with wards < 2$).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nDescriptives_Results <- read_csv(file = \"./Final_Dbs/2021_Party_Results_Descriptives_2023-01-06.csv\")%>% \n  sapply(.,as.character)%>%\n  data.frame()\n\nDescriptives_Results$occurence <- as.integer(Descriptives_Results$occurence)\n\nOther_Politics <- paste(Descriptives_Results[Descriptives_Results$occurence <=2,\"party_name\"],\n      collapse = \",\")\n\nWard_Results <- Ward_Results |>\n  mutate(party_name = case_when(party_name %in% c(\"AL JAMA-AH,KAROO GEMEENSKAP PARTY\",\"TEAM SUGAR SOUTH AFRICA\",\"UMSOBOMVU RESIDENTS ASSOCIATION\",\"ACTIONSA,AZANIA RESIDENT PARTY\",\"BREEDEVALLEI ONAFHANKLIK\",\"CAPRICORN INDEPENDENT COMMUNITY ACTIVISTS FORUM\",\"CEDERBERG FIRST RESIDENTS ASSOCIATION\",\"DIENSLEWERINGS PARTY\",\"FORUM 4 SERVICE DELIVERY\",\"INDEPENDENT SOUTH AFRICAN NATIONAL CIVIC ORGANISATION\",\"LAND PARTY,NAMAKWA CIVIC MOVEMENT\",\"PLETT DEMOCRATIC CONGRESS\",\"SIYATHEMBA COMMUNITY MOVEMENT\",\"TSOGANG CIVIC MOVEMENT,UNITED DEMOCRATIC MOVEMENT\"\n) ~ \"OTHER\",\n                                TRUE ~ party_name))\n\nWards_Plot <- Ward_Results |> \nggplot()+\n  geom_sf(aes(fill = party_name),colour=\"black\")+\n  scale_fill_manual(values = \n                      c(\"AFRICAN NATIONAL CONGRESS\"= \"#FFD700\",\n              \"DEMOCRATIC ALLIANCE\"= \"#00008B\",\n              \"INKATHA FREEDOM PARTY\"=\"#FFFF00\",\n              \"INDEPENDENT\"=\"#90EE90\",\n              \"ECONOMIC FREEDOM FIGHTERS\"=\"#8b0000\",\n              \"MAPSIXTEEN CIVIC MOVEMENT\"=\"#9F2B68\",\n              \"NATIONAL FREEDOM PARTY\"=\"#808080\",\n              \"VRYHEIDSFRONT PLUS\"=\"#FFA500\",\n              \"PATRIOTIC ALLIANCE\"=\"#39FF14\",\n              \"ABANTU BATHO CONGRESS\"=\"#ADD8E6\",\n              \"AFRICAN PEOPLE'S MOVEMENT\"=\"#FFFFE0\",\n              \"GOOD\"=\"#F5E236\",\n              \"INDEPENDENT CIVIC ORGANISATION OF SOUTH AFRICA\"=\"#FA1138\",\n              \"SETSOTO SERVICE DELIVERY FORUM\"=\"#A5FA11\",\n              \"AL JAMA-AH\"= \"#334A05\",\n              \"KAROO GEMEENSKAP PARTY\"=\"#5BF5A3\",\n              \"TEAM SUGAR SOUTH AFRICA\"=\"#F2FF03\",\n              \"UMSOBOMVU RESIDENTS ASSOCIATION\"=\"#141212\",\n              \"OTHER\" = \"#FFC0CB\"))+\n  labs(title = \"2021 Local Government Election Results\",\n       subtitle = \"Ballot Type (Ward): Winning Party per ward in the 2021 South African Local Government Elections.\\nThe results do not include other ballot types such as DC 40% or Proportional Representation.\",\n       caption = \"Data Source: https://www.elections.org.za/\\nPlot: Sivuyile Nzimeni(sivuyilenzimeni.netlify.app)\",\n       fill = \"Party Name\")+\n  theme_void()+\n  theme(text = element_text(\"IBM Plex Sans\"),\n        plot.title =element_text(hjust=0.5,face = \"bold\"),\n        plot.subtitle = element_text(hjust = 0.5,face = \"italic\"),\n        plot.caption = element_text(hjust=0.8,face = \"italic\"),\n        legend.position = \"bottom\")\n\nWard_Results <-Ward_Results |> \n  left_join(Descriptives_Results |> select(-occurence))\n\nWard_Results <- Ward_Results |> \n  mutate(overview = paste0(\"<strong>\",Province,\"</strong>\",\"<br/>\",\n                              \"<strong>\",Municipali,\"</strong>\",\"<br/>\",\n                              '<strong>Ward ID</strong>',\"<br/>\",WardID,\"<br/>\",\n                              \"<strong>Winner</strong>:\",party_name,\"<br/>\",\n                              \"<strong>Support</strong>: \",round(support,2),\"%\"),\n         colour = str_trim(colour))\n\nWard_Results <- Ward_Results |> \n  mutate(overview = lapply(overview,htmltools::HTML)) |> \n  unnest(overview)\n```\n:::\n\n\n# VISUALISATION\n\n\n::: {.cell fig-caption='A map containing all the 4468 wards in South Africa along with the winning parties in the last LGE.'}\n\n```{.r .cell-code}\nWards_Plot\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/2021 LGE Results ward results-1.png){width=3000}\n:::\n:::\n\n\nThe resulting static visualisation illustrates that the African National Congress (ANC) won the majority of wards in South Africa followed by the Democratic Alliance (DA) in some urban areas. The visualisation above has be read in context.\n\n1.  **Land does not vote**: the composition of wards is influenced by several factors such as population density, level of development, natural landscape etc. As such, it is possible to have a large ward (by land size) with minimal low density and vice versa.\n2.  **Ward-Outcomes are partial**: in Local Government Elections, voters have at least two ballots, direct votes and indirect votes. For Example, ActionSA obtained one ward in the 2021 LGE, they obtained more than 50 seats in the provinces where they competed.\n3.  **Rigour**: for a more comprehensive analysis, spatial econometrics offers a number of tools to help understand voting patterns over time. Naturally, the datasets required would need to be expanded to include Statistics South Africa (Census), previous voting patterns (IEC) and former demarcations (MDB).\n\n::: callout-important\n## Rendering Issue\n\nR has several packages for interactive visualisation. In the code, we attempted to use leaflet to render the interactive visualisation. The size of the data appears to be a hindrance, instead generating an error `Fatal javascript OOM in Reached heap limit`. Other users have experienced this issue. Follow [Issue 2462](https://github.com/quarto-dev/quarto-cli/issues/2462) for more information and progress on the issue.\n\nThe rendering works locally. The script above provides the cleaning process before creating an interactive map in \\`leaflet\\` or another interactive visualisation library.\n:::\n\n# SUMMARY\n\nIn the post, we imported a spatial data file from MDB along with election results from the IEC. Ward-Level outcomes are visualised through a choropleth map.\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}